/*
 * Requires:
 *     psiturk.js
 *     utils.js
 */

// Initalize psiturk object
var psiTurk = new PsiTurk(uniqueId, adServerLoc, mode);

var mycondition = condition;  // these two variables are passed by the psiturk server process
var mycounterbalance = 0; //counterbalance;  // they tell you which condition you have been assigned to
var final_numcorrect;
var practice_mode = true;

// All pages to be loaded
var pages = [
	"instructions/instruct-1.html",
	"instructions/instruct-2.html",
	"instructions/instruct-fail.html",
	"instructions/instruct-ready.html",
	"stage.html",
	"postquestionnaire.html"
];

psiTurk.preloadPages(pages);

var firstInstructionPages = [
	"instructions/instruct-1.html",
	"instructions/instruct-2.html",
];

var secondInstructionPages = [
	"instructions/instruct-ready.html"
];

var failInstructionPages = [
	"instructions/instruct-fail.html"
];


/********************
* HTML manipulation
*
* All HTML files in the templates directory are requested 
* from the server when the PsiTurk object is created above. We
* need code to get those pages from the PsiTurk object and 
* insert them into the document.
*
********************/

var WSCExperiment = function() {

	var questionon, // time from when question is presented to subject response
       NONE = 0,
       READSENTENCE = 1,
       READQANDANS = 2,
       FEEDBACK = 3,
       input_mode = NONE;

	// Winograd Schema questions
   //

   // practice
   // generated by make_questions.jl on 2015-02-13T12:45:41 with seed=838
   var practiceQuestions = [
      ["The bird flew too close to Tara, so it swerved.", "Who swerved?", "Tara", "The Bird", 1],
      ["The bird flew too close to Tara, so she ducked.", "Who ducked?", "The Bird", "Tara", 1],
      ["The children played with their games until they got tired of them.", "Who got tired of the games?", "The games", "The children", 1],
      ["The children played with their games until they got tired of them.", "What did the children get tired of?", "The games", "The children", 0],
      ["John went to bed because he was tired and it looked comfortable.", "What looked comfortable?", "John", "The bed", 1],
      ["John went to bed because he was tired and it looked comfortable.", "Who was tired?", "John", "The bed", 0],
      ["The toys were scattered across the floor. It was almost completely covered.", "What was covered?", "The toys", "The floor", 1],
      ["The toys were scattered across the floor. It was almost completely covered.", "What was covered?", "The toys", "The floor", 1],
      ["The predator stalked the prey. It didn't escape.", "What didn't escape?", "The predator", "The prey", 1],
      ["The predator stalked the prey. It didn't escape.", "What didn't escape?", "The predator", "The prey", 1],
      ["The drivers in several cars honked at the jaywalkers because they were mad at them.", "Who were mad?", "The drivers", "The jaywalkers", 0],
      ["The drivers in several cars honked at the jaywalkers because they were mad at them.", "Who were people mad at?", "The drivers", "The jaywalkers", 1],
      ["Barry gave his jacket to Shawn because he was very cold.", "Who was cold?", "Shawn", "Barry", 0],
      ["Barry gave his jacket to Shawn because he was very warm.", "Who was warm?", "Shawn", "Barry", 1],
      ["Sandy's room is filled with books in bookshelves. They are her favorites.", "Which are her favorites?", "The bookshelves", "The books", 1],
      ["Sandy's room is filled with books in bookshelves. They are anchored to the wall.", "Which are anchored to the wall?", "The books", "The bookshelves", 1],
   ];

   var r01 = function() {
      return Math.floor(Math.random()*2);
   }

   var practiceIndices = [ 0+r01(), 2+r01(), 4+r01(), 6+r01(),
                           8+r01(),10+r01(),12+r01(),14+r01() ];  // pick randomly between two versions/arms

   // test
   // generated by make_questions.jl on 2015-02-13T12:45:35 with seed=838
   var questions = [
      ["The city councilmen refused the demonstrators a permit because they feared violence.", "Who feared violence?", "The city councilmen", "The demonstrators", 0],
      ["The city councilmen refused the demonstrators a permit because they advocated violence.", "Who advocated violence?", "The city councilmen", "The demonstrators", 1],
      ["The trophy doesn't fit into the brown suitcase because it's too small.", "What is too small?", "The trophy", "The suitcase", 1],
      ["The trophy doesn't fit into the brown suitcase because it's too large.", "What is too large?", "The trophy", "The suitcase", 0],
      ["Joan made sure to thank Susan for all the help she had given.", "Who had given help?", "Susan", "Joan", 0],
      ["Joan made sure to thank Susan for all the help she had received.", "Who had received help?", "Susan", "Joan", 1],
      ["Paul tried to call George on the phone, but he wasn't successful.", "Who was not successful?", "Paul", "George", 0],
      ["Paul tried to call George on the phone, but he wasn't available.", "Who was not available?", "Paul", "George", 1],
      ["The lawyer asked the witness a question, but he was reluctant to answer it.", "Who was reluctant to answer the question?", "The lawyer", "The witness", 1],
      ["The lawyer asked the witness a question, but he was reluctant to repeat it.", "Who was reluctant to repeat the question?", "The witness", "The lawyer", 1],
      ["The delivery truck zoomed by the school bus because it was going so fast.", "What was going so fast?", "The bus", "The truck", 1],
      ["The delivery truck zoomed by the school bus because it was going so slow.", "What was going so slow?", "The bus", "The truck", 0],
      ["Frank felt vindicated when his longtime rival Bill revealed that he was the winner of the competition.", "Who was the winner of the competition?", "Frank", "Bill", 0],
      ["Frank felt crushed when his longtime rival Bill revealed that he was the winner of the competition.", "Who was the winner of the competition?", "Frank", "Bill", 1],
      ["The man couldn't lift his son because he was so weak.", "Who was weak?", "The man", "The son", 0],
      ["The man couldn't lift his son because he was so heavy.", "Who was heavy?", "The man", "The son", 1],
      ["The large ball crashed right through the table because it was made of steel.", "What was made of steel?", "The table", "The ball", 1],
      ["The large ball crashed right through the table because it was made of styrofoam.", "What was made of styrofoam?", "The ball", "The table", 1],
      ["John couldn't see the stage with Billy in front of him because he is so short.", "Who is so short?", "John", "Billy", 0],
      ["John couldn't see the stage with Billy in front of him because he is so tall.", "Who is so tall?", "John", "Billy", 1],
      ["Tom threw his schoolbag down to Ray after he reached the top of the stairs.", "Who reached the top of the stairs?", "Ray", "Tom", 1],
      ["Tom threw his schoolbag down to Ray after he reached the bottom of the stairs.", "Who reached the bottom of the stairs?", "Tom", "Ray", 1],
      ["Although they ran at about the same speed, Sue beat Sally because she had such a good start.", "Who had a good start?", "Sally", "Sue", 1],
      ["Although they ran at about the same speed, Sue beat Sally because she had such a bad start.", "Who had a bad start?", "Sally", "Sue", 0],
      ["The sculpture rolled off the shelf because it wasn't anchored.", "What wasn't anchored?", "The sculpture", "The shelf", 0],
      ["The sculpture rolled off the shelf because it wasn't level.", "What wasn't level?", "The shelf", "The sculpture", 0],
      ["Sam's drawing was hung just above Tina's and it did look much better with another one below it.", "Which looked better?", "Tina's drawing", "Sam's drawing", 1],
      ["Sam's drawing was hung just above Tina's and it did look much better with another one above it.", "Which looked better?", "Sam's drawing", "Tina's drawing", 1],
      ["Anna did a lot better than her good friend Lucy on the test because she had studied so hard.", "Who studied hard?", "Anna", "Lucy", 0],
      ["Anna did a lot worse than her good friend Lucy on the test because she had studied so hard.", "Who studied hard?", "Lucy", "Anna", 0],
      ["The firemen arrived after the police because they were coming from so far away.", "Who came from far away?", "The firemen", "The police", 0],
      ["The firemen arrived before the police because they were coming from so far away.", "Who came from far away?", "The police", "The firemen", 0],
      ["Frank was upset with Tom because the toaster he had bought from him didn't work.", "Who had bought the toaster?", "Frank", "Tom", 0],
      ["Frank was upset with Tom because the toaster he had sold to him didn't work.", "Who had sold the toaster?", "Tom", "Frank", 0],
      ["Jim yelled at Kevin because he was so upset.", "Who was upset?", "Jim", "Kevin", 0],
      ["Jim comforted Kevin because he was so upset.", "Who was upset?", "Kevin", "Jim", 0],
      ["The sack of potatoes had been placed above the bag of flour, so it had to be moved first.", "What had to be moved first?", "The sack of potatoes", "The bag of flour", 0],
      ["The sack of potatoes had been placed below the bag of flour, so it had to be moved first.", "What had to be moved first?", "The sack of potatoes", "The bag of flour", 1],
      ["Pete envies Martin because he is very successful.", "Who is very successful?", "Martin", "Pete", 0],
      ["Pete envies Martin although he is very successful.", "Who is very successful?", "Martin", "Pete", 1],
      ["I was trying to balance the bottle upside down on the table, but I couldn't do it because it was so top-heavy.", "What was top-heavy?", "The table", "The bottle", 1],
      ["I was trying to balance the bottle upside down on the table, but I couldn't do it because it was so uneven.", "What was uneven?", "The bottle", "The table", 1],
      ["I spread the cloth on the table in order to protect it.", "To protect what?", "The table", "The cloth", 0],
      ["I spread the cloth on the table in order to display it.", "To display what?", "The cloth", "The table", 0],
      ["The older students were bullying the younger ones, so we rescued them.", "Whom did we rescue?", "The older students", "The younger students", 1],
      ["The older students were bullying the younger ones, so we punished them.", "Whom did we punish?", "The older students", "The younger students", 0],
      ["I poured water from the bottle into the cup until it was full.", "What was full?", "The cup", "The bottle", 0],
      ["I poured water from the bottle into the cup until it was empty.", "What was empty?", "The cup", "The bottle", 1],
      ["Susan knows all about Ann's personal problems because she is nosy.", "Who is nosy?", "Anne", "Susan", 1],
      ["Susan knows all about Ann's personal problems because she is indiscreet.", "Who is indiscreet?", "Anne", "Susan", 0],
      ["Sid explained his theory to Mark but he couldn't convince him.", "Who did not convince whom?", "Mark did not convince Sid", "Sid did not convince Mark", 1],
      ["Sid explained his theory to Mark but he couldn't understand him.", "Who did not understand whom?", "Sid did not understand Mark", "Mark did not understand Sid", 1],
      ["Susan knew that Ann's son had been in a car accident, so she told her about it.", "Who told the other about the accident?", "Ann", "Susan", 1],
      ["Susan knew that Ann's son had been in a car accident, because she told her about it.", "Who told the other about the accident?", "Ann", "Susan", 0],
      ["Joe's uncle can still beat him at tennis, even though he is 30 years older.", "Who is older?", "Joe's uncle", "Joe", 0],
      ["Joe's uncle can still beat him at tennis, even though he is 30 years younger.", "Who is younger?", "Joe's uncle", "Joe", 1],
      ["The police left the house and went into the garage, where they found the murder weapon.", "Where did they find the murder weapon?", "In the garage", "In the house", 0],
      ["The police left the house and went into the garage, after they found the murder weapon.", "Where did they find the murder weapon?", "In the garage", "In the house", 1],
      ["The painting in Mark's living room shows an oak tree. It is to the right of the bookcase.", "What is to the right of the bookcase?", "The tree", "The painting", 1],
      ["The painting in Mark's living room shows an oak tree. It is to the right of a house.", "What is to the right of a house?", "The painting", "The tree", 1],
      ["There is a gap in the wall. You can see the garden through it.", "You can see the garden through what?", "The gap", "The wall", 0],
      ["There is a gap in the wall. You can see the garden behind it.", "You can see the garden behind what?", "The gap", "The wall", 1],
      ["The drain is clogged with hair. It has to be cleaned.", "What has to be cleaned?", "The drain", "The hair", 0],
      ["The drain is clogged with hair. It has to be removed.", "What has to be removed?", "The hair", "The drain", 0],
      ["My meeting started at 4:00 and I needed to catch the train at 4:30, so there wasn't much time. Luckily, it was short, so it worked out.", "What was short?", "The train", "The meeting", 1],
      ["My meeting started at 4:00 and I needed to catch the train at 4:30, so there wasn't much time. Luckily, it was delayed, so it worked out.", "What was delayed?", "The train", "The meeting", 0],
      ["There is a pillar between me and the stage, and I can't see it.", "What can't I see?", "The stage", "The pillar", 0],
      ["There is a pillar between me and the stage, and I can't see around it.", "What can't I see around?", "The pillar", "The stage", 0],
      ["They broadcast an announcement, but a subway came into the station and I couldn't hear it.", "What couldn't I hear?", "The announcement", "The subway", 0],
      ["They broadcast an announcement, but a subway came into the station and I couldn't hear over it.", "What couldn't I hear over?", "The subway", "The announcement", 0],
      ["In the middle of the outdoor concert, the rain started falling, and it continued until 10.", "What continued until 10?", "The rain", "The concert", 0],
      ["In the middle of the outdoor concert, the rain started falling, but it continued until 10.", "What continued until 10?", "The concert", "The rain", 0],
      ["I used an old rag to clean the knife, and then I put it in the drawer.", "What did I put in the drawer?", "The rag", "The knife", 1],
      ["I used an old rag to clean the knife, and then I put it in the trash.", "What did I put in the trash?", "The rag", "The knife", 0],
      ["Ann asked Mary what time the library closes, but she had forgotten.", "Who had forgotten?", "Ann", "Mary", 1],
      ["Ann asked Mary what time the library closes, because she had forgotten.", "Who had forgotten?", "Mary", "Ann", 1],
      ["I took the water bottle out of the backpack so that it would be lighter.", "What would be lighter?", "The bottle", "The backpack", 1],
      ["I took the water bottle out of the backpack so that it would be handy.", "What would be handy?", "The bottle", "The backpack", 0],
      ["I couldn't put the pot on the shelf because it was too high.", "What was too high?", "The shelf", "The pot", 0],
      ["I couldn't put the pot on the shelf because it was too tall.", "What was too tall?", "The pot", "The shelf", 0],
      ["I'm sure that my map will show this building; it is very famous.", "What is famous?", "The building", "The map", 0],
      ["I'm sure that my map will show this building; it is very good.", "What is good?", "The map", "The building", 0],
      ["Bob paid for Charlie's college education. He is very generous.", "Who is generous?", "Charlie", "Bob", 1],
      ["Bob paid for Charlie's college education. He is very grateful.", "Who is grateful?", "Charlie", "Bob", 0],
      ["Bob paid for Charlie's college education, but now Charlie acts as though it never happened. He is very hurt.", "Who is hurt?", "Bob", "Charlie", 0],
      ["Bob paid for Charlie's college education, but now Charlie acts as though it never happened. He is very ungrateful.", "Who is ungrateful?", "Charlie", "Bob", 0],
      ["Bob was playing cards with Adam and was way ahead. If Adam hadn't had a sudden run of good luck, he would have won.", "Who would have won?", "Adam", "Bob", 1],
      ["Bob was playing cards with Adam and was way ahead. If Adam hadn't had a sudden run of good luck, he would have lost.", "Who would have lost?", "Adam", "Bob", 0],
      ["Adam can't leave work here until Bob arrives to replace him. If Bob had left home for work on time, he would be here by this time.", "Who would be here?", "Bob", "Adam", 0],
      ["Adam can't leave work here until Bob arrives to replace him. If Bob had left home for work on time, he would be gone by this time.", "Who would be gone?", "Adam", "Bob", 0],
      ["If the con artist has succeeded in fooling Sam, he would have gotten a lot of money.", "Who would have gotten the money?", "The con artist", "Sam", 0],
      ["If the con artist has succeeded in fooling Sam, he would have lost a lot of money.", "Who would have lost the money?", "The con artist", "Sam", 1],
      ["It was a summer afternoon, and the dog was sitting in the middle of the lawn. After a while, it got up and moved to a spot under the tree, because it was hot.", "What was hot?", "The spot under the tree", "The dog", 1],
      ["It was a summer afternoon, and the dog was sitting in the middle of the lawn. After a while, it got up and moved to a spot under the tree, because it was cooler.", "What was cooler?", "The dog", "The spot under the tree", 1],
      ["The cat was lying by the mouse hole waiting for the mouse, but it was too cautious.", "What was too cautious?", "The mouse", "The cat", 0],
      ["The cat was lying by the mouse hole waiting for the mouse, but it was too impatient.", "What was too impatient?", "The cat", "The mouse", 0],
      ["Anne gave birth to a daughter last month. She is a very charming woman.", "Who is a very charming woman?", "Anne", "Anne's daughter", 0],
      ["Anne gave birth to a daughter last month. She is a very charming baby.", "Who is a very charming baby?", "Anne", "Anne's daughter", 1],
      ["Alice tried frantically to stop her daughter from chatting at the party, leaving us to wonder why she was behaving so strangely.", "Who was behaving strangely?", "Alice", "Alice's daughter", 0],
      ["Alice tried frantically to stop her daughter from barking at the party, leaving us to wonder why she was behaving so strangely.", "Who was behaving strangely?", "Alice's daughter", "Alice", 0],
      ["I saw Jim yelling at some guy in a military uniform with a huge red beard. I don't know who he was, but he looked very unhappy.", "Who looked very unhappy?", "The guy in the uniform", "Jim", 0],
      ["I saw Jim yelling at some guy in a military uniform with a huge red beard. I don't know why he was, but he looked very unhappy.", "Who looked very unhappy?", "Jim", "The guy in the uniform", 0],
      ["The fish ate the worm. It was tasty.", "What was tasty?", "The fish", "The worm", 1],
      ["The fish ate the worm. It was hungry.", "What was hungry?", "The fish", "The worm", 0],
      ["I was trying to open the lock with the key, but someone had filled the keyhole with chewing gum, and I couldn't get it in.", "What couldn't I get in?", "The key", "The chewing gum", 0],
      ["I was trying to open the lock with the key, but someone had filled the keyhole with chewing gum, and I couldn't get it out.", "What couldn't I get out?", "The key", "The chewing gum", 1],
      ["The dog chased the cat, which ran up a tree. It waited at the top.", "Which waited at the top?", "The cat", "The dog", 0],
      ["The dog chased the cat, which ran up a tree. It waited at the bottom.", "Which waited at the bottom?", "The cat", "The dog", 1],
      ["In the storm, the tree fell down and crashed through the roof of my house. Now, I have to get it removed.", "What has to be removed?", "The tree", "The roof", 0],
      ["In the storm, the tree fell down and crashed through the roof of my house. Now, I have to get it repaired.", "What has to be repaired?", "The tree", "The roof", 1],
      ["The customer walked into the bank and stabbed one of the tellers. He was immediately taken to the emergency room.", "Who was taken to the emergency room?", "The customer", "The teller", 1],
      ["The customer walked into the bank and stabbed one of the tellers. He was immediately taken to the police station.", "Who was taken to the police station?", "The teller", "The customer", 1],
      ["John was doing research in the library when he heard a man humming and whistling. He was very annoyed.", "Who was annoyed?", "The hummer", "John", 1],
      ["John was doing research in the library when he heard a man humming and whistling. He was very annoying.", "Who was annoying?", "John", "The hummer", 1],
      ["John was jogging through the park when he saw a man juggling watermelons. He was very impressed.", "Who was impressed?", "The juggler", "John", 1],
      ["John was jogging through the park when he saw a man juggling watermelons. He was very impressive.", "Who was impressive?", "The juggler", "John", 0],
      ["Bob collapsed on the sidewalk. Soon he saw Carl coming to help. He was  very ill.", "Who was ill?", "Bob", "Carl", 0],
      ["Bob collapsed on the sidewalk. Soon he saw Carl coming to help. He was  very concerned.", "Who was concerned?", "Carl", "Bob", 0],
      ["Sam and Amy are passionately in love, but Amy's parents are unhappy about it, because they are snobs.", "Who are snobs?", "Amy's parents", "Sam and Amy", 0],
      ["Sam and Amy are passionately in love, but Amy's parents are unhappy about it, because they are fifteen.", "Who are fifteen?", "Amy's parents", "Sam and Amy", 1],
      ["Mark told Pete many lies about himself, which Pete included in his book. He should have been more truthful.", "Who should have been more truthful?", "Mark", "Pete", 0],
      ["Mark told Pete many lies about himself, which Pete included in his book. He should have been more skeptical.", "Who should have been more skeptical?", "Mark", "Pete", 1],
      ["Joe has sold his house and bought a new one a few miles away. He will be moving out of it on Thursday.", "Which house will he be moving out of?", "The new house", "The old house", 1],
      ["Joe has sold his house and bought a new one a few miles away. He will be moving into it on Thursday.", "Which house will he be moving into?", "The new house", "The old house", 0],
      ["Many people start to read Paul's books and can't put them down. They are gripped because Paul writes so well.", "Who or what are gripped?", "The books", "The readers", 1],
      ["Many people start to read Paul's books and can't put them down. They are popular because Paul writes so well.", "Who or what are popular?", "The books", "The readers", 0],
      ["Mary took out her flute and played one of her favorite pieces. She has loved it since she was a child.", "What has Mary loved since she was a child?", "The flute", "The piece", 1],
      ["Mary took out her flute and played one of her favorite pieces. She has had it since she was a child.", "What has Mary had since she was a child?", "The flute", "The piece", 0],
      ["Sam pulled up a chair to the piano, but it was broken, so he had to stand instead.", "What was broken?", "The chair", "The piano", 0],
      ["Sam pulled up a chair to the piano, but it was broken, so he had to sing instead.", "What was broken?", "The chair", "The piano", 1],
      ["Since it was raining, I carried the newspaper over my backpack to keep it dry.", "What was I trying to keep dry?", "The backpack", "The newspaper", 0],
      ["Since it was raining, I carried the newspaper in my backpack to keep it dry.", "What was I trying to keep dry?", "The backpack", "The newspaper", 1],
      ["Sara borrowed the book from the library because she needs it for an article she is working on. She reads it when she gets home from work.", "What does Sara read when she gets home from work?", "The book", "The article", 0],
      ["Sara borrowed the book from the library because she needs it for an article she is working on. She writes it when she gets home from work.", "What does Sara write when she gets home from work?", "The article", "The book", 0],
      ["This morning, Joey built a sand castle on the beach, and put a toy flag in the highest tower, but this afternoon the wind knocked it down.", "What did the wind knock down?", "The sand castle", "The flag", 1],
      ["This morning, Joey built a sand castle on the beach, and put a toy flag in the highest tower, but this afternoon the tide knocked it down.", "What did the tide knock down?", "The flag", "The sand castle", 1],
      ["Jane knocked on Susan's door, but there was no answer. She was out.", "Who was out?", "Jane", "Susan", 1],
      ["Jane knocked on Susan's door, but there was no answer. She was disappointed.", "Who was disappointed?", "Susan", "Jane", 1],
      ["Jane knocked on the door, and Susan answered it. She invited her to come out.", "Who invited whom?", "Jane invited Susan", "Susan invited Jane", 0],
      ["Jane knocked on the door, and Susan answered it. She invited her to come in.", "Who invited whom?", "Susan invited Jane", "Jane invited Susan", 0],
      ["Sam took French classes from Adam, because he was eager to speak it fluently.", "Who was eager to speak French fluently?", "Sam", "Adam", 0],
      ["Sam took French classes from Adam, because he was known to speak it fluently.", "Who was known to speak French fluently?", "Sam", "Adam", 1],
      ["The path to the lake was blocked, so we couldn't reach it.", "What couldn't we reach?", "The path", "The lake", 1],
      ["The path to the lake was blocked, so we couldn't use it.", "What couldn't we use?", "The lake", "The path", 1],
      ["The sun was covered by a thick cloud all morning, but luckily, by the time the picnic started, it was gone.", "What was gone?", "The sun", "The cloud", 1],
      ["The sun was covered by a thick cloud all morning, but luckily, by the time the picnic started, it was out.", "What was out?", "The sun", "The cloud", 0],
      ["We went to the lake, because a shark had been seen at the ocean beach, so it was a dangerous place to swim.", "Which was a dangerous place to swim?", "The beach", "The lake", 0],
      ["We went to the lake, because a shark had been seen at the ocean beach, so it was a safer place to swim.", "Which was a safer place to swim?", "The lake", "The beach", 0],
      ["Sam tried to paint a picture of shepherds with sheep, but they ended up looking more like dogs.", "What looked like dogs?", "The sheep", "The shepherds", 0],
      ["Sam tried to paint a picture of shepherds with sheep, but they ended up looking more like golfers.", "What looked like golfers?", "The sheep", "The shepherds", 1],
      ["Mary tucked her daughter Anne into bed, so that she could sleep.", "Who is going to sleep?", "Mary", "Anne", 1],
      ["Mary tucked her daughter Anne into bed, so that she could work.", "Who is going to work?", "Mary", "Anne", 0],
      ["Fred and Alice had very warm down coats, but they were not enough for the cold in Alaska.", "Who or what were not enough for the cold?", "Fred and Alice", "The coats", 1],
      ["Fred and Alice had very warm down coats, but they were not prepared for the cold in Alaska.", "Who or what were not prepared for the cold?", "The coats", "Fred and Alice", 1],
      ["Thomson visited Cooper's grave in 1765. At that date he had been dead for five years.", "Who had been dead for five years?", "Cooper", "Thomson", 0],
      ["Thomson visited Cooper's grave in 1765. At that date he had been travelling for five years.", "Who had been travelling for five years?", "Cooper", "Thomson", 1],
      ["Jackson was greatly influenced by Arnold, though he lived two centuries earlier.", "Who lived earlier?", "Arnold", "Jackson", 0],
      ["Jackson was greatly influenced by Arnold, though he lived two centuries later.", "Who lived later?", "Arnold", "Jackson", 1],
      ["Tom's daughter Eva is engaged to Dr. Stewart, who is his partner. The two doctors have known one another for ten years.", "Which two people have known one another for ten years?", "Eva and Dr. Stewart", "Tom and Dr. Stewart", 1],
      ["Tom's daughter Eva is engaged to Dr. Stewart, who is his partner. The two lovers have known one another for ten years.", "Which two people have known one another for ten years?", "Eva and Dr. Stewart", "Tom and Dr. Stewart", 0],
      ["I can't cut that tree down with that axe; it is too thick.", "What is too thick?", "The tree", "The axe", 0],
      ["I can't cut that tree down with that axe; it is too small.", "What is too small?", "The axe", "The tree", 0],
      ["The foxes are getting in at night and attacking the chickens. I shall have to guard them.", "What do I have to guard?", "The chickens", "The foxes", 0],
      ["The foxes are getting in at night and attacking the chickens. I shall have to kill them.", "What do I have to kill?", "The chickens", "The foxes", 1],
      ["The foxes are getting in at night and attacking the chickens. They have gotten very bold.", "What has gotten bold?", "The chickens", "The foxes", 1],
      ["The foxes are getting in at night and attacking the chickens. They have gotten very nervous.", "What has gotten nervous?", "The foxes", "The chickens", 1],
      ["Fred covered his eyes with his hands, because the wind was blowing sand around. He opened them when the wind stopped.", "What did Fred open?", "His eyes", "His hands", 0],
      ["Fred covered his eyes with his hands, because the wind was blowing sand around. He lowered them when the wind stopped.", "What did Fred lower?", "His hands", "His eyes", 0],
      ["The actress used to be named Terpsichore, but she changed it to Tina a few years ago, because she figured it was easier to pronounce.", "Which name was easier to pronounce?", "Terpsichore", "Tina", 1],
      ["The actress used to be named Terpsichore, but she changed it to Tina a few years ago, because she figured it was too hard to pronounce.", "Which name was too hard to pronounce?", "Terpsichore", "Tina", 0],
      ["Fred watched TV while George went out to buy groceries. After an hour he got up.", "Who got up?", "Fred", "George", 0],
      ["Fred watched TV while George went out to buy groceries. After an hour he got back.", "Who got back?", "Fred", "George", 1],
      ["Fred was supposed to run the dishwasher, but he put it off, because he wanted to watch TV. But the show turned out to be boring, so he changed his mind and turned it on.", "What did Fred turn on?", "The television", "The dishwasher", 1],
      ["Fred was supposed to run the dishwasher, but he put it off, because he wanted to watch TV. But the show turned out to be boring, so he changed his mind and turned it off.", "What did Fred turn off?", "The dishwasher", "The television", 1],
      ["Fred is the only man still alive who remembers my great-grandfather. He is a remarkable man.", "Who is a remarkable man?", "My great-grandfather", "Fred", 1],
      ["Fred is the only man still alive who remembers my great-grandfather. He was a remarkable man.", "Who was a remarkable man?", "My great-grandfather", "Fred", 0],
      ["Fred is the only man alive who still remembers my father as an infant. When Fred first saw my father, he was twelve years old.", "Who was twelve years old?", "My father", "Fred", 1],
      ["Fred is the only man alive who still remembers my father as an infant. When Fred first saw my father, he was twelve months old.", "Who was twelve months old?", "My father", "Fred", 0],
      ["In July, Kamtchatka declared war on Yakutsk. Since Yakutsk's army was much better equipped and ten times larger, they were victorious within weeks.", "Who was victorious?", "Kamchatka", "Yakutsk", 1],
      ["In July, Kamtchatka declared war on Yakutsk. Since Yakutsk's army was much better equipped and ten times larger, they were defeated within weeks.", "Who was defeated?", "Kamchatka", "Yakutsk", 0],
      ["Elizabeth moved her company from Sparta to Troy to save money on taxes; the taxes are much higher there.", "Where are the taxes higher?", "In Troy", "In Sparta", 1],
      ["Elizabeth moved her company from Sparta to Troy to save money on taxes; the taxes are much lower there.", "Where are the taxes lower?", "In Sparta", "In Troy", 1],
      ["Esther figures that she will save shipping costs if she builds her factory in Springfield instead of Franklin, because most of her customers live there.", "In which town do most of Esther's customers live?", "Springfield", "Franklin", 0],
      ["Esther figures that she will save shipping costs if she builds her factory in Springfield instead of Franklin, because none of her customers live there.", "In which town do none of Esther's customers live?", "Franklin", "Springfield", 0],
      ["Look! There is a shark swimming right below that duck! It had better get away to safety fast!", "What needs to get away to safety?", "The shark", "The duck", 1],
      ["Look! There is a minnow swimming right below that duck! It had better get away to safety fast!", "What needs to get away to safety?", "The minnow", "The duck", 0],
      ["There are too many deer in the park, so the park service brought in a small pack of wolves. The population should increase over the next few years.", "Which population will increase?", "The deer", "The wolves", 1],
      ["There are too many deer in the park, so the park service brought in a small pack of wolves. The population should decrease over the next few years.", "Which population will decrease?", "The wolves", "The deer", 1],
      ["Archaeologists have concluded that humans lived in Laputa 20,000 years ago. They hunted for deer on the river banks.", "Who hunted for deer?", "The archaeologists", "The prehistoric humans", 1],
      ["Archaeologists have concluded that humans lived in Laputa 20,000 years ago. They hunted for evidence on the river banks.", "Who hunted for evidence?", "The archaeologists", "The prehistoric humans", 0],
      ["The scientists are studying three species of fish that have recently been found living in the Indian Ocean. They appeared two years ago.", "Who or what appeared two years ago?", "The fish", "The scientists", 0],
      ["The scientists are studying three species of fish that have recently been found living in the Indian Ocean. They began two years ago.", "Who or what began two years ago?", "The fish", "The scientists", 1],
      ["The journalists interviewed the stars of the new movie. They were very cooperative, so the interview lasted for a long time.", "Who was cooperative?", "The stars", "The journalists", 0],
      ["The journalists interviewed the stars of the new movie. They were very persistent, so the interview lasted for a long time.", "Who was persistent?", "The journalists", "The stars", 0],
      ["The police arrested all of the gang members. They were trying to run the drug trade in the neighborhood.", "Who was trying to run the drug trade?", "The police", "The gang", 1],
      ["The police arrested all of the gang members. They were trying to stop the drug trade in the neighborhood.", "Who was trying to stop the drug trade?", "The gang", "The police", 1],
      ["I put the cake away in the refrigerator. It has a lot of butter in it.", "What has a lot of butter?", "The cake", "The refrigerator", 0],
      ["I put the cake away in the refrigerator. It has a lot of leftovers in it.", "What has a lot of leftovers?", "The refrigerator", "The cake", 0],
      ["Sam broke both his ankles and he's walking with crutches. But a month or so from now they should be better.", "What should be better?", "The crutches", "The ankles", 1],
      ["Sam broke both his ankles and he's walking with crutches. But a month or so from now they should be unnecessary.", "What should be unnecessary?", "The ankles", "The crutches", 1],
      ["When the sponsors of the bill got to the town hall, they were surprised to find that the room was full of opponents. They were very much in the majority.", "Who were in the majority?", "The opponents", "The sponsors", 0],
      ["When the sponsors of the bill got to the town hall, they were surprised to find that the room was full of opponents. They were very much in the minority.", "Who were in the minority?", "The opponents", "The sponsors", 1],
      ["Everyone really loved the oatmeal cookies; only a few people liked the chocolate chip cookies. Next time, we should make more of them.", "Which cookie should we make more of, next time?", "The chocolate chip", "The oatmeal cookies", 1],
      ["Everyone really loved the oatmeal cookies; only a few people liked the chocolate chip cookies. Next time, we should make fewer of them.", "Which cookie should we make fewer of, next time?", "The chocolate chip", "The oatmeal cookies", 0],
      ["We had hoped to place copies of our newsletter on all the chairs in the auditorium, but there were simply too many of them.", "There are too many of what?", "Chairs", "Copies of the newsletter", 0],
      ["We had hoped to place copies of our newsletter on all the chairs in the auditorium, but there were simply not enough of them.", "There are not enough of what?", "Copies of the newsletter", "Chairs", 0],
      ["I stuck a pin through a carrot. When I pulled the pin out, it left a hole.", "What left a hole?", "The pin", "The carrot", 0],
      ["I stuck a pin through a carrot. When I pulled the pin out, it had a hole.", "What had a hole?", "The carrot", "The pin", 0],
      ["I couldn't find a spoon, so I tried using a pen to stir my coffee. But that turned out to be a bad idea, because it got full of ink.", "What got full of ink?", "The coffee", "The pen", 0],
      ["I couldn't find a spoon, so I tried using a pen to stir my coffee. But that turned out to be a bad idea, because it got full of coffee.", "What got full of coffee?", "The coffee", "The pen", 1],
      ["Steve follows Fred's example in everything. He admires him hugely.", "Who admires whom?", "Fred admires Steve", "Steve admires Fred", 1],
      ["Steve follows Fred's example in everything. He influences him hugely.", "Who influences whom?", "Fred influences Steve", "Steve influences Fred", 0],
      ["The table won't fit through the doorway because it is too wide.", "What is too wide?", "The table", "The doorway", 0],
      ["The table won't fit through the doorway because it is too narrow.", "What is too narrow?", "The doorway", "The table", 0],
      ["Grace was happy to trade me her sweater for my jacket. She thinks it looks great on her.", "What looks great on Grace?", "The jacket", "The sweater", 0],
      ["Grace was happy to trade me her sweater for my jacket. She thinks it looks dowdy on her.", "What looks dowdy on Grace?", "The sweater", "The jacket", 0],
      ["Bill thinks that calling attention to himself was rude to Bert.", "Who called attention to himself?", "Bert", "Bill", 1],
      ["Bill thinks that calling attention to himself was rude of Bert.", "Who called attention to himself?", "Bert", "Bill", 0],
      ["John hired Bill to take care of him.", "Who is taking care of whom?", "John is taking care of Bill", "Bill is taking care of John", 1],
      ["John hired himself out to Bill to take care of him.", "Who is taking care of whom?", "Bill is taking care of John", "John is taking care of Bill", 1],
      ["John promised Bill to leave, so an hour later he left.", "Who left?", "Bill", "John", 1],
      ["John ordered Bill to leave, so an hour later he left.", "Who left?", "John", "Bill", 1],
      ["Sam Goodman's biography of the Spartan general Xenophanes conveys a vivid sense of the difficulties he faced in his childhood.", "Who faced difficulties?", "Xenophanes", "Sam", 0],
      ["Sam Goodman's biography of the Spartan general Xenophanes conveys a vivid sense of the difficulties he faced in his research.", "Who faced difficulties?", "Sam", "Xenophanes", 0],
      ["Emma's mother had died long ago, and her place had been taken by an excellent woman as governess.", "Whose place had been taken?", "Emma", "Emma's mother", 1],
      ["Emma's mother had died long ago, and her education had been managed by an excellent woman as governess.", "Whose education had been managed?", "Emma", "Emma's mother", 0],
      ["Jane knocked on Susan's door but she did not answer.", "Who did not answer?", "Jane", "Susan", 1],
      ["Jane knocked on Susan's door but she did not get an answer.", "Who did not get an answer?", "Susan", "Jane", 1],
      ["Joe paid the detective after he received the final report on the case.", "Who received the final report?", "Joe", "The detective", 0],
      ["Joe paid the detective after he delivered the final report on the case.", "Who delivered the final report?", "Joe", "The detective", 1],
      ["Beth didn't get angry with Sally, who had cut her off, because she stopped and counted to ten.", "Who counted to ten?", "Sally", "Beth", 1],
      ["Beth didn't get angry with Sally, who had cut her off, because she stopped and apologized.", "Who apologized?", "Sally", "Beth", 0],
      ["Jim signaled the barman and gestured toward his empty glass.", "Whose empty glass?", "The barman", "Jim", 1],
      ["Jim signaled the barman and gestured toward his bathroom key.", "Whose bathroom key?", "The barman", "Jim", 0],
      ["Dan took the rear seat while Bill claimed the front because his \"Dibs!\" was quicker.", "Whose \"Dibs\" was quicker?", "Dan", "Bill", 1],
      ["Dan took the rear seat while Bill claimed the front because his \"Dibs!\" was slow.", "Whose \"Dibs\" was slow?", "Bill", "Dan", 1],
      ["Tom said \"Check\" to Ralph as he took his bishop.", "Whose bishop did Tom take?", "Tom's", "Ralph's", 1],
      ["Tom said \"Check\" to Ralph as he moved his bishop.", "Whose bishop did Tom move?", "Ralph's", "Tom's", 1],
      ["As Andrea in the crop duster passed over Susan, she could see the landing strip.", "Who could see the landing strip?", "Andrea", "Susan", 0],
      ["As Andrea in the crop duster passed over Susan, she could see the landing gear.", "Who could see the landing gear?", "Susan", "Andrea", 0],
      ["Tom gave Ralph a lift to school so he wouldn't have to walk.", "Who wouldn't have to walk?", "Tom", "Ralph", 1],
      ["Tom gave Ralph a lift to school so he wouldn't have to drive alone.", "Who wouldn't have to drive alone?", "Tom", "Ralph", 0],
      ["Bill passed the half-empty plate to John because he was full.", "Who was full?", "Bill", "John", 0],
      ["Bill passed the half-empty plate to John because he was hungry.", "Who was hungry?", "John", "Bill", 0],
      ["Bill passed the gameboy to John because his turn was over.", "Whose turn was over?", "Bill", "John", 0],
      ["Bill passed the gameboy to John because his turn was next.", "Whose turn was next?", "John", "Bill", 0],
      ["The man lifted the boy onto his bunk bed.", "Whose bunk bed?", "The man's", "The boy's", 1],
      ["The man lifted the boy onto his shoulders.", "Whose shoulders?", "The boy's", "The man's", 1],
      ["Patting her back, the woman smiled at the girl.", "Whose back did the woman pat?", "The girl's", "The woman's", 0],
      ["Stretching her back, the woman smiled at the girl.", "Whose back did the woman stretch?", "The girl's", "The woman's", 1],
      ["Billy cried because Toby wouldn't share his toy.", "Who owned the toy?", "Toby", "Billy", 0],
      ["Billy cried because Toby wouldn't accept his toy.", "Who owned the toy?", "Toby", "Billy", 1],
      ["Lily spoke to Donna, breaking her concentration.", "Whose concentration?", "Lily", "Donna", 1],
      ["Lily spoke to Donna, breaking her silence.", "Whose silence?", "Donna", "Lily", 1],
      ["When Tommy dropped his ice cream, Timmy giggled, so father gave him a stern look.", "Who got the look from father?", "Tommy", "Timmy", 1],
      ["When Tommy dropped his ice cream, Timmy giggled, so father gave him a sympathetic look.", "Who got the look from father?", "Tommy", "Timmy", 0],
      ["As Ollie carried Tommy up the long winding steps, his legs dangled.", "Whose legs dangled?", "Tommy", "Ollie", 0],
      ["As Ollie carried Tommy up the long winding steps, his legs ached.", "Whose legs ached?", "Ollie", "Tommy", 0],
      ["The father carried the sleeping boy in his arms.", "Whose arms?", "The boy", "The father", 1],
      ["The father carried the sleeping boy in his bassinet.", "Whose bassinet?", "The father", "The boy", 1],
      ["The woman held the girl against her chest.", "Whose chest?", "The girl's", "The woman's", 1],
      ["The woman held the girl against her will.", "Whose will?", "The girl's", "The woman's", 0],
      ["Pam's parents came home and found her having sex with her boyfriend, Paul. They were embarrassed about it.", "Who were embarrassed?", "Pam's parents", "Pam and Paul", 1],
      ["Pam's parents came home and found her having sex with her boyfriend, Paul. They were furious about it.", "Who were furious?", "Pam and Paul", "Pam's parents", 1],
      ["Dr. Adams informed Kate that she had cancer and presented several options for future treatment.", "Who had cancer?", "Dr. Adams", "Kate", 1],
      ["Dr. Adams informed Kate that she had retired and presented several options for future treatment.", "Who had retired?", "Dr. Adams", "Kate", 0],
      ["Dan had to stop Bill from toying with the injured bird. He is very compassionate.", "Who is compassionate?", "Bill", "Dan", 1],
      ["Dan had to stop Bill from toying with the injured bird. He is very cruel.", "Who is cruel?", "Dan", "Bill", 1],
      ["George got free tickets to the play, but he gave them to Eric because he was particularly eager to see it.", "Who was eager to see the play?", "George", "Eric", 1],
      ["George got free tickets to the play, but he gave them to Eric even though he was particularly eager to see it.", "Who was eager to see the play?", "Eric", "George", 1],
      ["George got free tickets to the play, but he gave them to Eric because he was not particularly eager to see it.", "Who was not eager to see the play?", "Eric", "George", 1],
      ["George got free tickets to the play, but he gave them to Eric even though he was not particularly eager to see it.", "Who was not eager to see the play?", "Eric", "George", 0],
      ["Jane gave Joan candy because she was hungry.", "Who was hungry?", "Jane", "Joan", 1],
      ["Jane gave Joan candy because she wasn't hungry.", "Who wasn't hungry?", "Jane", "Joan", 0],
      ["I tried to paint a picture of an orchard, with lemons in the lemon trees, but they came out looking more like light bulbs.", "What looked like light bulbs?", "The trees", "The lemons", 1],
      ["I tried to paint a picture of an orchard, with lemons in the lemon trees, but they came out looking more like telephone poles.", "What looked like telephone poles?", "The trees", "The lemons", 0],
      ["James asked Robert for a favor but he refused.", "Who refused?", "James", "Robert", 1],
      ["James asked Robert for a favor but he was refused.", "Who was refused?", "James", "Robert", 0],
      ["Kirilov ceded the presidency to Shatov because he was more popular.", "Who was more popular?", "Shatov", "Kirilov", 0],
      ["Kirilov ceded the presidency to Shatov because he was less popular.", "Who was less popular?", "Kirilov", "Shatov", 0],
      ["Emma did not pass the ball to Janie although she was open.", "Who was open?", "Janie", "Emma", 0],
      ["Emma did not pass the ball to Janie although she saw that she was open.", "Who saw that the other player was open?", "Janie", "Emma", 1],
      ["Joe saw his brother skiing on TV last night but the fool didn't recognize him.", "Who is the fool?", "Joe", "Joe's brother", 0],
      ["Joe saw his brother skiing on TV last night but the fool didn't have a coat on.", "Who is the fool?", "Joe's brother", "Joe", 0],
      ["I put the heavy book on the table and it broke.", "What broke?", "The book", "The table", 1],
      ["I put the butterfly wing on the table and it broke.", "What broke?", "The butterfly wing", "The table", 0],
      ["Tom told Alice he needed five more minutes to get ready.", "Who needed more time?", "Alice", "Tom", 1],
      ["Tom told Alice he needed five more minutes to get ready.", "Who was told that more time was needed?", "Alice", "Tom", 0],
      ["Sean threw the football to his teammate Brian.", "Who is Sean's teammate?", "Brian", "Sean", 0],
      ["Sean threw the football to his teammate Brian.", "Who is Sean's teammate?", "Brian", "Sean", 0],
      ["The roosters kept Jim up all night with their crowing, so he was tired the next morning.", "Who was crowing?", "The roosters", "Jim", 0],
      ["The roosters kept Jim up all night with their crowing, so he was tired the next morning.", "Who was tired in the morning?", "Jim", "The roosters", 0],
      ["Sarah always visits her uncle Barry at his home on the first of the month. She is very consistent.", "Who is consistent?", "Sarah", "Uncle Barry", 0],
      ["Sarah always visits her uncle Barry at his home on the first of the month. She is very consistent.", "Whose home does Sarah visit?", "Sarah's", "Uncle Barry's", 1],
      ["Although Pete usually found it soothing, today the grandfather clock irritated him with its endless ticking.", "What did Pete usually find soothing?", "Today", "The ticking of the clock", 1],
      ["Although Pete usually found it soothing, today the grandfather clock irritated him with its endless ticking.", "Who was irritated?", "The grandfather clock", "Pete", 1],
      ["Sam broke his leg and had to walk on crutches. Using them made him miserable.", "Who was miserable?", "The crutches", "Sam", 1],
      ["Sam broke his leg and had to walk on crutches. Using them made him miserable.", "What made Sam miserable?", "Using the crutches", "Sam's leg", 0],
      ["Steve always ends up going along with whatever everyone else wants because he is a pushover.", "Who is a pushover?", "Everyone else", "Steve", 1],
      ["Steve always ends up going along with whatever everyone else wants because he is a pushover.", "Who is a pushover?", "Steve", "Everyone else", 0],
      ["The law was clear on the issue and Ralph knew it. He would simply have to grit his teeth and pay the fine.", "Who would have to pay?", "Ralph", "The law", 0],
      ["The law was clear on the issue and Ralph knew it. He would simply have to grit his teeth and pay the fine.", "Who would have to pay?", "Ralph", "The law", 0],
      ["Dad sent the children to the other room because they were playing loudly and he needed to work.", "Who were playing loudly?", "Dad", "The children", 1],
      ["Dad sent the children to the other room because they were playing loudly and he needed to work.", "Who needed to work?", "Dad", "The children", 0],
      ["Sarah finally found the article she was looking for in the filing cabinet. Dan had misfiled it under the author's name instead of the title.", "What had been misfiled?", "The article", "The filing cabinet", 0],
      ["Sarah finally found the article she was looking for in the filing cabinet. Dan had misfiled it under the author's name instead of the title.", "Who was looking for the article?", "Sarah", "Dan", 0],
      ["Although she tried to stop it, Pam's tray slid off the table and crashed onto the floor.", "Who tried to stop the tray from falling?", "Pam", "The floor", 0],
      ["Although she tried to stop it, Pam's tray slid off the table and crashed onto the floor.", "Who tried to stop the tray from falling?", "The floor", "Pam", 1],
      ["Robert and John are always getting into fights. They have been bitter enemies for as long as they can remember.", "Who are enemies?", "Robert and John", "The fights", 0],
      ["Robert and John are always getting into fights. They have been bitter enemies for as long as they can remember.", "Who are enemies?", "The fights", "Robert and John", 1],
      ["The goalie dove for the ball but he missed it.", "Who dove?", "The ball", "The goalie", 1],
      ["The goalie dove for the ball but he missed it.", "What was missed?", "The goalie", "The ball", 1],
      ["The fishermen relaxed in their rowboat, waiting for a hungry fish to come along.", "Who were in the boat?", "A hungry fish", "The fishermen", 1],
      ["The fishermen relaxed in their rowboat, waiting for a hungry fish to come along.", "Who were in the boat?", "The fishermen", "A hungry fish", 0],
      ["The teacher gave the students an advanced math test. It was challenging for them.", "Who gave the test?", "The teacher", "The students", 0],
      ["The teacher gave the students an advanced math test. It was challenging for them.", "What was challenging for the students?", "The teacher", "The test", 1],
      ["This morning Jim flipped a coin ten times and got heads every time! This really surprised him.", "What surprised Jim?", "The morning", "Flipping heads ten times", 1],
      ["This morning Jim flipped a coin ten times and got heads every time! This really surprised him.", "Who was surprised?", "Jim", "The coin", 0],
      ["Sue was badly injured in the car accident. She had to go to the hospital.", "Who had to go to the hospital?", "The accident", "Sue", 1],
      ["Sue was badly injured in the car accident. She had to go to the hospital.", "Who had to go to the hospital?", "Sue", "The accident", 0],
   ];
   var allIndices = [
      [1,8,32,58,64,70,84,85,98,103,116,125,133,145,153,158,165,167,187,189,201,211,213,215,220,227,235,236,244,246,251,255,257,258,263,264,276,289,292,319] 
   ];

   var myIndices;
   var thequestions;
   if (practice_mode==true) {
      myIndices = practiceIndices;
	   myIndices = _.shuffle(myIndices);
      thequestions = practiceQuestions;
   } else {
      myIndices = allIndices[mycounterbalance];
      thequestions = questions;
   }

   var qnum = 0;
   var numcorrect = 0;

	var next = function() {
		if (myIndices.length===0) {
			finish();
		}
		else {
         qnum += 1;
         thisIndex = myIndices.shift();
			stim = thequestions[thisIndex];
			show_text(stim[0]);
         input_mode = READSENTENCE;
         d3.select("#instruct").html('<p id="prompt">Read the sentence(s) above. Press <b>SPACE</b> when you are done.</p>');
		}
	};
	
	var response_handler = function(e) {
		var keyCode = e.keyCode,
			response;

      if (input_mode == READSENTENCE) {
         if (keyCode==32) { // space
            input_mode = READQANDANS;
            show_question_ans(stim[1], stim[2], stim[3]);
            d3.select("#instruct").html('<p id="prompt">Answer by pressing <b>1</b> or <b>2</b> as quickly as you can while remaining accurate.</p>');
			   questionon = new Date().getTime();
         }
      } else if (input_mode == READQANDANS) {
         switch (keyCode) {
            case 49: // 1
               response = 0;
               break;
            case 50: // 2
               response = 1;
               break;
            default:
               response = -1;
               break;
         }
         if (response>=0) {
            input_mode = FEEDBACK;
            var hit = response == stim[4];
            if (hit) {
               numcorrect += 1
            }
            var rt = new Date().getTime() - questionon;

            psiTurk.recordTrialData({'phase':practice_mode ? "PRACTICE":"TEST",
                                        'expnum':2,
                                        'session':mycounterbalance,
                                        'qnum':qnum,
                                        'index':thisIndex,
                                        'response':response,
                                        'hit':hit,
                                        'rt':rt}
                                      );
            remove_text();
            remove_question_ans();
            show_feedback(hit, numcorrect, qnum);
            d3.select("#instruct").html('<p id="prompt">Press <b>ENTER</b> when you are ready to continue.</p>');
         }
      } else if (input_mode == FEEDBACK) {
         if (keyCode==13) { // enter
            input_mode = NONE;
            remove_feedback();
            next();
         }
      }
	};

	var finish = function() {
      if (practice_mode==true) {
         practice_mode = false;
	      $("body").unbind("keydown", response_handler); // Unbind keys
         var thresh = (practiceQuestions.length/2)*.7; // gotta be at least 70%
         console.log(thresh);
         if (numcorrect<thresh) {
            psiTurk.recordUnstructuredData("practice", "fail");
            psiTurk.doInstructions(
              failInstructionPages,
              function() { self.close(); } // ?? FIXME
            );
         } else {
            psiTurk.recordUnstructuredData("practice", "pass");
            psiTurk.doInstructions(
              secondInstructionPages,
              function() { currentview = new WSCExperiment(); }
            );
         }
      } else {
	      $("body").unbind("keydown", response_handler); // Unbind keys
         final_numcorrect = numcorrect;
	      currentview = new Questionnaire();
      }
	};
	
	var show_text = function(text) {
		d3.select("#stim")
			.append("div")
			.attr("id","sentence")
			.text(text);
	};

	var show_question_ans = function(question, ans1, ans2) {
		d3.select("#query")
			.append("div")
			.attr("id","question")
			.text(question);
		d3.select("#ans1")
			.append("div")
			.attr("id","answer1")
			.text("1.  " + ans1);
		d3.select("#ans2")
			.append("div")
			.attr("id","answer2")
			.text("2.  " + ans2);
	};

	var show_feedback = function(hit, numcorrect, qnum) {
      var feedback_text;
      if (hit) {
         feedback_text = "Correct.    (current score: " + numcorrect + "/" + qnum + ")";
      } else {
         feedback_text = "Incorrect.    (current score: " + numcorrect + "/" + qnum + ")";
      }
		d3.select("#query")
			.append("div")
			.attr("id","question")
			.text(feedback_text);
	};

	var remove_text = function() {
		d3.select("#sentence").remove();
	};

	var remove_question_ans = function() {
		d3.select("#question").remove();
		d3.select("#answer1").remove();
		d3.select("#answer2").remove();
	};

	var remove_feedback = function() {
		d3.select("#question").remove();
	};

	
	// Load the stage.html snippet into the body of the page
	psiTurk.showPage('stage.html');

	// Register the response handler that is defined above to handle any
	// key down events.
	$("body").focus().keydown(response_handler); 

	// Start the test
	next();
};


/****************
* Questionnaire *
****************/

var Questionnaire = function() {

	var error_message = "<h1>Oops!</h1><p>Something went wrong submitting your HIT. This might happen if you lose your internet connection. Press the button to resubmit.</p><button id='resubmit'>Resubmit</button>";

	record_responses = function() {

		psiTurk.recordTrialData({'phase':'postquestionnaire', 'status':'submit'});

		$('textarea').each( function(i, val) {
			psiTurk.recordUnstructuredData(this.id, this.value);
		});
		$('select').each( function(i, val) {
			psiTurk.recordUnstructuredData(this.id, this.value);		
		});

	};

	prompt_resubmit = function() {
		replaceBody(error_message);
		$("#resubmit").click(resubmit);
	};

	resubmit = function() {
		replaceBody("<h1>Trying to resubmit...</h1>");
		reprompt = setTimeout(prompt_resubmit, 10000);
		
		psiTurk.saveData({
			success: function() {
			    clearInterval(reprompt); 
                psiTurk.computeBonus('compute_bonus', function(){finish()}); 
			}, 
			error: prompt_resubmit
		});
	};

	// Load the questionnaire snippet 
	psiTurk.showPage('postquestionnaire.html');
   var payment = final_numcorrect / 40.0 * 1.00;
   var paytext = "In addition, because you got " + final_numcorrect + " answers correct (out of 40), you will also receive a bonus of $" + payment.toFixed(2) + ".";
   $("#ques_paytext").html(paytext);
	psiTurk.recordTrialData({'phase':'postquestionnaire', 'status':'begin'});
   psiTurk.recordUnstructuredData("bonus_payment", payment.toFixed(2));		
	
	$("#next").click(function () {
	    record_responses();
	    psiTurk.saveData({
            success: function(){
                psiTurk.computeBonus('compute_bonus', function() { 
                	psiTurk.completeHIT(); // when finished saving compute bonus, the quit
                }); 
            }, 
            error: prompt_resubmit});
	});
    
	
};

// Task object to keep track of the current phase
var currentview;

/*******************
 * Run Task
 ******************/
$(window).load( function(){
    psiTurk.doInstructions(
    	firstInstructionPages, // a list of pages you want to display in sequence
    	function() { currentview = new WSCExperiment(); } // what you want to do when you are done with instructions
    );
});
